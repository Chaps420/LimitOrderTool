<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XRPL Limit Order Tool [v2.3] - Batch Order Creation</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <link rel="stylesheet" href="./src/css/styles.css">
    
    <!-- Load XRPL library from CDN - using stable version -->
    <script src="https://unpkg.com/xrpl@2.7.0/dist/xrpl-latest-min.js"></script>
    
    <!-- Fallback XRPL library loading -->
    <script>
        window.addEventListener('load', function() {
            if (!window.xrpl) {
                console.warn('Primary XRPL library failed to load, trying fallback...');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/xrpl@2.7.0/dist/xrpl-latest-min.js';
                script.onload = function() {
                    console.log('‚úÖ XRPL fallback library loaded');
                };
                script.onerror = function() {
                    console.error('‚ùå Both XRPL libraries failed to load');
                };
                document.head.appendChild(script);
            } else {
                console.log('‚úÖ XRPL library loaded successfully');
                console.log('üìã Available XRPL methods:', Object.keys(window.xrpl));
            }
        });
    </script>
    
    <!-- Suppress browser extension console warnings -->
    <script>
        // Suppress common browser extension console warnings and errors
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('chrome.runtime') || 
                message.includes('isDevEnv()') || 
                message.includes('ethereum.js') ||
                message.includes('trusted site') ||
                message.includes('Pippit') ||
                message.includes('contentScript') ||
                message.includes('isolated-script') ||
                message.includes('NonBackgroundMessenger') ||
                message.includes('RemoteApiShutdownError') ||
                message.includes('Receiving end does not exist') ||
                message.includes('feature-flags') ||
                message.includes('midnight-wallet') ||
                message.includes('midnight-authenticator')) {
                return; // Suppress these specific warnings
            }
            originalConsoleError.apply(console, args);
        };
        
        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('chrome.runtime') || 
                message.includes('isDevEnv()') || 
                message.includes('ethereum.js') ||
                message.includes('trusted site') ||
                message.includes('Pippit') ||
                message.includes('contentScript') ||
                message.includes('isolated-script') ||
                message.includes('uniswap.org')) {
                return; // Suppress these specific warnings
            }
            originalConsoleWarn.apply(console, args);
        };
        
        // Suppress unhandled promise rejections from browser extensions
        window.addEventListener('unhandledrejection', function(event) {
            const message = event.reason?.message || event.reason?.toString() || '';
            if (message.includes('chrome.runtime') ||
                message.includes('RemoteApiShutdownError') ||
                message.includes('feature-flags') ||
                message.includes('midnight-wallet') ||
                message.includes('isolated-script')) {
                event.preventDefault();
                return;
            }
        });
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <h1>XRPL<span class="accent">Trader</span></h1>
                </div>
                <div class="header-actions">
                    <div class="backend-status" id="backend-status">
                        <span class="status-text">Checking mode...</span>
                    </div>
                    <div class="network-status" id="networkStatus">
                        <span class="status-dot"></span>
                        <span class="status-text">Connecting...</span>
                    </div>
                    <button class="btn btn-primary" id="connectWallet">
                        Connect Wallet
                    </button>
                    <button class="btn btn-secondary" id="disconnectWallet" style="display: none;">
                        Disconnect
                    </button>
                    <div class="wallet-info" id="walletInfo" style="display: none;">
                        <span class="wallet-address" id="walletAddress"></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Hero Section -->
                <section class="hero">
                    <h2>Automated Limit Order Distribution</h2>
                    <p>Create multiple limit sell orders across market cap ranges with a single signature</p>
                </section>

                <!-- Strategy Selector -->
                <section class="strategy-section">
                    <div class="section-header">
                        <h3>Order Strategy</h3>
                    </div>

                    <!-- Market Cap Strategy -->
                    <div class="strategy-content active" id="marketCapStrategy">
                        <div class="card">
                            <div class="card-header">
                                <h4>Distribution Settings</h4>
                            </div>
                            <div class="card-body">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="tokenSelect">Select Token</label>
                                        <select id="tokenSelect" class="form-control">
                                            <option value="">Choose a token...</option>
                                            <option value="custom">Enter Custom Token</option>
                                        </select>
                                        <div class="custom-token-input" id="customTokenInput" style="display: none;">
                                            <input type="text" id="customTokenCode" placeholder="Token Code" class="form-control">
                                            <input type="text" id="customTokenIssuer" placeholder="Token Issuer Address" class="form-control">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="tokenSupply">Token Supply</label>
                                        <input type="number" id="tokenSupply" placeholder="1,000,000,000" class="form-control">
                                    </div>

                                    <div class="form-group">
                                        <label for="bottomMarketCap">Bottom Market Cap ($)</label>
                                        <input type="number" id="bottomMarketCap" placeholder="1,000,000" class="form-control">
                                    </div>

                                    <div class="form-group">
                                        <label for="topMarketCap">Top Market Cap ($)</label>
                                        <input type="number" id="topMarketCap" placeholder="10,000,000" class="form-control">
                                    </div>

                                    <div class="form-group">
                                        <label for="orderCount">Number of Orders</label>
                                        <input type="number" id="orderCount" placeholder="10" min="2" max="50" class="form-control">
                                    </div>

                                    <div class="form-group">
                                        <label for="totalTokens">Total Token Amount</label>
                                        <input type="number" id="totalTokens" placeholder="1,000,000" class="form-control">
                                    </div>
                                </div>

                                <!-- Distribution Method Selection -->
                                <div class="distribution-method">
                                    <div class="form-group checkbox-group">
                                        <div class="method-description">
                                            <span class="linear-desc">‚úÖ Linear (Default): Evenly spaced price intervals</span>
                                            <span class="logarithmic-desc">üìà Logarithmic: More orders at lower prices</span>
                                        </div>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="useLogarithmic" class="checkbox">
                                            <span class="checkbox-text">Check for Logarithmic Distribution</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button class="btn btn-secondary" id="calculateOrders">Calculate Orders</button>
                                    <button class="btn btn-primary" id="createOrders" disabled>Create Orders</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Order Preview -->
                <section class="preview-section" id="previewSection" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h4>Order Preview</h4>
                            <div class="preview-stats">
                                <span class="stat">
                                    <span class="stat-label">Distribution:</span>
                                    <span class="stat-value" id="distributionType">Linear</span>
                                </span>
                                <span class="stat">
                                    <span class="stat-label">Total Orders:</span>
                                    <span class="stat-value" id="totalOrdersCount">0</span>
                                </span>
                                <span class="stat">
                                    <span class="stat-label">Total XRP Expected:</span>
                                    <span class="stat-value" id="totalXRPExpected">0</span>
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="orders-table-container">
                                <table class="orders-table">
                                    <thead>
                                        <tr>
                                            <th>Order #</th>
                                            <th>Price (XRP)</th>
                                            <th>Amount (Tokens)</th>
                                            <th>Market Cap</th>
                                            <th>Total XRP</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ordersPreviewBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="preview-actions">
                                <button class="btn btn-primary btn-large" id="signTransaction">
                                    Sign Transaction with Xaman
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Transaction Status -->
                <section class="status-section" id="statusSection" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h4>Transaction Status</h4>
                        </div>
                        <div class="card-body">
                            <div class="status-display" id="statusDisplay">
                                <!-- Status updates will appear here -->
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
        
        <!-- QR Code Modal -->
        <div id="qrModal" class="qr-modal" style="display: none;">
            <div class="qr-modal-overlay" onclick="closeQRModal()"></div>
            <div class="qr-modal-content">
                <div class="qr-modal-header">
                    <h3>üîó Scan QR Code with Xaman App</h3>
                    <button class="qr-close-btn" onclick="closeQRModal()">&times;</button>
                </div>
                <div class="qr-modal-body">
                    <div class="qr-code-container">
                        <div id="qrCodeDisplay" class="qr-code-display">
                            <!-- Remove default loading content -->
                            <div class="qr-placeholder">
                                <p>QR Code will appear here when needed</p>
                            </div>
                        </div>
                    </div>
                    <div class="qr-instructions">
                        <p>üì± <strong>Instructions:</strong></p>
                        <ol>
                            <li>Open the Xaman app on your phone</li>
                            <li>Tap the "Scan" button or QR scanner</li>
                            <li>Point your camera at the QR code above</li>
                            <li>Review and sign the transaction in the app</li>
                        </ol>
                        <div class="qr-status" id="qrStatus">
                            Waiting for you to scan and sign...
                        </div>
                    </div>
                </div>
                <div class="qr-modal-footer">
                    <button onclick="copyXamanLink()" class="btn btn-secondary">üìã Copy Deep Link</button>
                    <button onclick="closeQRModal()" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // QR Modal Functions (Global)
        let currentXamanLink = '';
        
        window.showQRModal = function(qrCodeUrl, xamanLink) {
            console.log('üì± showQRModal called with:', { qrCodeUrl, xamanLink });
            console.trace('Call stack for showQRModal:'); // Add stack trace to find caller
            
            // If no QR code URL provided, don't show modal
            if (!qrCodeUrl) {
                console.error('‚ùå showQRModal called without QR code URL - blocking modal');
                return;
            }
            
            currentXamanLink = xamanLink || qrCodeUrl;
            
            const modal = document.getElementById('qrModal');
            const qrDisplay = document.getElementById('qrCodeDisplay');
            
            // Force remove any conflicting styles first
            modal.style.removeProperty('display');
            modal.style.removeProperty('visibility');
            
            // Use requestAnimationFrame to ensure DOM updates
            requestAnimationFrame(() => {
                // Show modal with maximum priority using cssText
                modal.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important; pointer-events: auto !important; z-index: 99999 !important;';
                
                // Also ensure the modal is not hidden by parent elements
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
                console.log('üîç Modal display after setting:', window.getComputedStyle(modal).display);
                console.log('üîç Modal visibility after setting:', window.getComputedStyle(modal).visibility);
                console.log('üîç Modal computed styles:', {
                    display: window.getComputedStyle(modal).display,
                    visibility: window.getComputedStyle(modal).visibility,
                    opacity: window.getComputedStyle(modal).opacity,
                    zIndex: window.getComputedStyle(modal).zIndex
                });
            });
            
            // Clear previous content and show loading
            qrDisplay.innerHTML = `
                <div class="qr-loading">
                    <div class="spinner"></div>
                    <p>Generating QR Code...</p>
                </div>
            `;
            
            // Add a longer delay to ensure QR code loads properly
            setTimeout(() => {
                // Create image element with proper loading
                const img = new Image();
                img.onload = function() {
                    qrDisplay.innerHTML = `<img src="${qrCodeUrl}" alt="QR Code for Xaman" class="qr-code-image">`;
                    console.log('‚úÖ QR code image loaded successfully');
                };
                img.onerror = function() {
                    qrDisplay.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: #dc3545;">
                            <p>‚ùå Failed to load QR code</p>
                            <button onclick="copyXamanLink()" class="btn btn-primary" style="margin-top: 1rem;">üìã Copy Link Instead</button>
                        </div>
                    `;
                    console.error('‚ùå Failed to load QR code image');
                };
                img.src = qrCodeUrl;
            }, 500); // Reduced delay to 0.5 seconds
        };
        
        window.closeQRModal = function() {
            const modal = document.getElementById('qrModal');
            modal.style.cssText = 'display: none !important; visibility: hidden !important;';
            document.body.style.overflow = ''; // Restore scrolling
            currentXamanLink = '';
        };
        
        window.updateQRStatus = function(message, type = 'info') {
            const qrStatus = document.getElementById('qrStatus');
            if (qrStatus) {
                qrStatus.textContent = message;
                qrStatus.className = 'qr-status';
                if (type === 'success') {
                    qrStatus.style.background = 'rgba(40, 167, 69, 0.2)';
                    qrStatus.style.borderColor = 'rgba(40, 167, 69, 0.5)';
                    qrStatus.style.color = '#28a745';
                } else if (type === 'error') {
                    qrStatus.style.background = 'rgba(220, 53, 69, 0.2)';
                    qrStatus.style.borderColor = 'rgba(220, 53, 69, 0.5)';
                    qrStatus.style.color = '#dc3545';
                } else {
                    qrStatus.style.background = 'rgba(255, 193, 7, 0.1)';
                    qrStatus.style.borderColor = 'rgba(255, 193, 7, 0.3)';
                    qrStatus.style.color = '#ffc107';
                }
            }
        };
        
        function copyXamanLink() {
            if (currentXamanLink) {
                navigator.clipboard.writeText(currentXamanLink).then(() => {
                    // Show success feedback
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ Copied!';
                    btn.style.background = '#28a745';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy link:', err);
                    // Fallback: show the link in an alert
                    alert('Copy this link to your clipboard:\n\n' + currentXamanLink);
                });
            }
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                window.closeQRModal();
            }
        });
        
        // Add diagnostic function
        window.debugQRModal = function() {
            const modal = document.getElementById('qrModal');
            console.log('üîç QR Modal Debug Info:');
            console.log('Element exists:', !!modal);
            if (modal) {
                console.log('Inline styles:', modal.style.cssText);
                console.log('Computed styles:', {
                    display: window.getComputedStyle(modal).display,
                    visibility: window.getComputedStyle(modal).visibility,
                    opacity: window.getComputedStyle(modal).opacity,
                    position: window.getComputedStyle(modal).position,
                    zIndex: window.getComputedStyle(modal).zIndex,
                    width: window.getComputedStyle(modal).width,
                    height: window.getComputedStyle(modal).height
                });
                console.log('Parent element:', modal.parentElement);
                console.log('Modal HTML:', modal.outerHTML.substring(0, 200) + '...');
                
                // Check all stylesheets for rules affecting the modal
                const sheets = document.styleSheets;
                console.log('Checking stylesheets for #qrModal rules...');
                for (let i = 0; i < sheets.length; i++) {
                    try {
                        const rules = sheets[i].cssRules || sheets[i].rules;
                        for (let j = 0; j < rules.length; j++) {
                            if (rules[j].selectorText && rules[j].selectorText.includes('qrModal')) {
                                console.log('Found CSS rule:', rules[j].cssText);
                            }
                        }
                    } catch (e) {
                        // Skip cross-origin stylesheets
                    }
                }
            }
        };
        
        // Wait for XRPL library to load before initializing the app
        async function waitForXRPL() {
            let attempts = 0;
            const maxAttempts = 50; // 5 seconds max wait
            
            while (typeof window.xrpl === 'undefined' && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (typeof window.xrpl === 'undefined') {
                console.error('‚ùå XRPL library failed to load');
                document.body.insertAdjacentHTML('beforeend', 
                    '<div style="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 1rem; border-radius: 8px; z-index: 9999;">‚ùå XRPL library failed to load. Please refresh the page.</div>'
                );
            } else {
                console.log('‚úÖ XRPL library loaded successfully');
                console.log('‚úÖ Page loaded, QR code will use fallback API method');
            }
        }
        
        // Start waiting for XRPL library
        waitForXRPL();
        
        // Add page load debugging and ensure QR modal is hidden
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM loaded - checking QR modal state');
            const modal = document.getElementById('qrModal');
            if (modal) {
                console.log('üîç QR modal display style:', window.getComputedStyle(modal).display);
                // Force hide the modal using cssText
                modal.style.cssText = 'display: none !important; visibility: hidden !important;';
                console.log('üîí QR modal forcibly hidden on page load');
                
                // Add debug button for testing (remove in production)
                console.log('üí° Type debugQRModal() in console to diagnose QR modal issues');
            }
        });
    </script>
    <script type="module" src="./src/js/app.js"></script>
</body>
</html>
